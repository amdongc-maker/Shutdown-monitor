function login(){
 const user=USERS.find(x=>x.u===loginUser.value && x.p===loginPass.value);
 if(!user){showMsg("Invalid Login");return;}
 CURRENT_USER=user;
 loginBox.classList.add("hidden");
 mainBox.classList.remove("hidden");
 populateFeeders();
 loadActiveShutdowns();
}

function populateFeeders(){
 sd_feeder.innerHTML=rs_feeder.innerHTML="";
 (FEEDERS[CURRENT_USER.i]||[]).forEach(f=>{
  sd_feeder.innerHTML+=`<option>${f}</option>`;
  rs_feeder.innerHTML+=`<option>${f}</option>`;
 });
}

function loadActiveShutdowns(){
 fetch(CSV_URL+"&t="+Date.now())
 .then(r=>r.text())
 .then(t=>{
  const rows=t.split("\n").map(r=>r.split(","));
  const h=rows.shift().map(x=>x.toUpperCase());

  const idx={
    feeder:h.findIndex(x=>x.includes("FEEDER")),
    type:h.findIndex(x=>x.includes("TYPE")),
    sd:h.findIndex(x=>x.includes("SHUTDOWN")),
    rs:h.findIndex(x=>x.includes("RESUME")),
    inst:h.findIndex(x=>x.includes("INSTALL"))
  };

  activeShutdowns.innerHTML="";
  ACTIVE_SHUTDOWNS={};
  let count=0;

  rows.forEach(r=>{
    if(!r[idx.rs] || r[idx.rs]==="NA"){
      count++;
      ACTIVE_SHUTDOWNS[r[idx.feeder]] = r[idx.sd];

      activeShutdowns.innerHTML+=`
      <div class="shutdown-item">
        <div class="shutdown-row"><span class="shutdown-label">FEEDER</span><span class="shutdown-value">${r[idx.feeder]}</span></div>
        <div class="shutdown-row"><span class="shutdown-label">TYPE</span><span class="shutdown-value">${r[idx.type]}</span></div>
        <div class="shutdown-row"><span class="shutdown-label">TIME</span><span class="shutdown-value">${r[idx.sd]}</span></div>
        <div class="shutdown-row"><span class="shutdown-label">INSTALLATION</span><span class="install-badge">${r[idx.inst]}</span></div>
      </div>`;
    }
  });

  if(count===0){
    activeShutdowns.innerHTML=`<div class="shutdown-item" style="text-align:center;font-weight:700;color:#27ae60">✅ All FEEDERS ARE HEALTHY</div>`;
  }
 });
}

function submitShutdown(){
 if(!sd_feeder.value || !sd_time.value || !sd_type.value || !sd_info.value.trim()){
   showMsg("❌ All shutdown fields required");
   return;
 }
 fetch(WEBAPP_URL+"?"+new URLSearchParams({
  action:"shutdown",
  feeder:sd_feeder.value,
  ShutdownTime:sd_time.value.replace("T"," "),
  ShutdownType:sd_type.value,
  Information:sd_info.value,
  ShutdownEntryBy:CURRENT_USER.n,
  Installation:CURRENT_USER.i
 }),{mode:"no-cors"});
 showMsg("✅ Shutdown Submitted");
 backToMain();
}

function submitResume(){
 if(!rs_feeder.value){showMsg("❌ Please select feeder");return;}
 if(!ACTIVE_SHUTDOWNS[rs_feeder.value]){
   showMsg("❌ Selected feeder is not in shutdown");
   return;
 }
 if(!rs_time.value){showMsg("❌ Please select Resume Time");return;}

 const sd = new Date(ACTIVE_SHUTDOWNS[rs_feeder.value].replace(" ","T"));
 const rs = new Date(rs_time.value);
 if(rs <= sd){
   showMsg("❌ Resume time must be after Shutdown time");
   return;
 }
 if(!rs_loss.value.trim() || !rs_dg.value.trim() || !rs_rem.value.trim()){
   showMsg("❌ All resume fields required");
   return;
 }

 fetch(WEBAPP_URL+"?"+new URLSearchParams({
  action:"resume",
  feeder:rs_feeder.value,
  ResumeTime:rs_time.value.replace("T"," "),
  ResumeEntryBy:CURRENT_USER.n,
  TotalProdLoss:rs_loss.value,
  DGDeployed:rs_dg.value,
  Remarks:rs_rem.value
 }),{mode:"no-cors"});
 showMsg("✅ Resume Submitted");
 backToMain();
}

function openShutdown(){mainBox.classList.add("hidden");shutdownBox.classList.remove("hidden")}
function openResume(){mainBox.classList.add("hidden");resumeBox.classList.remove("hidden")}
function backToMain(){
 shutdownBox.classList.add("hidden");
 resumeBox.classList.add("hidden");
 mainBox.classList.remove("hidden");
 loadActiveShutdowns();
}

function showMsg(t){
 msg.innerText=t;
 setTimeout(()=>msg.innerText="",3000);
}

setInterval(loadActiveShutdowns,30000);
</script>
</body>
</html>
