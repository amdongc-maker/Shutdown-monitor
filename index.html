<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Shutdown & Resume Power Management</title>

<style>
body{font-family:Segoe UI,Arial;background:#f4f6f8;margin:0}
header{background:#1f3a5f;color:#fff;padding:12px 20px;font-size:20px}
.container{padding:20px}
.card{background:#fff;padding:20px;border-radius:6px;margin-bottom:20px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
h3{margin-top:0;color:#1f3a5f}
label{display:block;margin-top:10px;font-weight:600}
select,input,textarea{width:100%;padding:8px;margin-top:4px}
textarea{resize:vertical}
button{padding:10px 18px;border:none;border-radius:4px;cursor:pointer;margin-right:5px}
.btn-login{background:#3498db;color:#fff}
.btn-shutdown{background:#e74c3c;color:#fff}
.btn-resume{background:#27ae60;color:#fff}
.footer{position:fixed;bottom:0;width:100%;background:#ecf0f1;padding:10px;text-align:center}
.hidden{display:none}
#msg{margin-top:5px;font-weight:bold}

.shutdown-item{
 background:#ffe6e6;
 color:#b30000;
 padding:8px;
 margin-bottom:6px;
 border-left:5px solid #e74c3c;
 font-weight:600;
}
</style>
</head>

<body>

<header>Shutdown & Resume Power Management</header>

<div class="container">

<!-- LOGIN -->
<div class="card" id="loginBox">
<h3>Operator Login</h3>

<label>Username</label>
<input id="loginUser">

<label>Password</label>
<input type="password" id="loginPass">

<br><br>
<button class="btn-login" onclick="login()">Login</button>
</div>

<!-- OPERATOR DETAILS -->
<div class="card hidden" id="operatorBox">
<h3>Operator Details</h3>

<label>Operator Name</label>
<input id="opName" disabled>

<label>Installation</label>
<input id="installation" disabled>
</div>

<!-- DASHBOARD -->
<div class="card hidden" id="dashboardBox">
<h3>Active Shutdown Feeders</h3>
<div id="activeShutdowns"></div>
<br>
<button class="btn-shutdown" onclick="openShutdown()">Shutdown Entry</button>
<button class="btn-resume" onclick="openResume()">Resume Entry</button>
</div>

<!-- SHUTDOWN -->
<div class="card hidden" id="shutdownBox">
<h3>Shutdown Entry</h3>

<label>Feeder</label>
<select id="sd_feeder"></select>

<label>Shutdown Time</label>
<input type="datetime-local" id="sd_time">

<label>Shutdown Type</label>
<select id="sd_type">
<option>PLAN PSD</option>
<option>PARTIAL PLAN PSD</option>
<option>UNPLAN PSD</option>
<option>PARTIAL UNPLAN PSD</option>
</select>

<label>Information</label>
<textarea id="sd_info"></textarea>

<br><br>
<button class="btn-shutdown" onclick="submitShutdown()">Submit Shutdown</button>
</div>

<!-- RESUME -->
<div class="card hidden" id="resumeBox">
<h3>Resume Entry</h3>

<label>Feeder</label>
<select id="rs_feeder"></select>

<label>Resume Time</label>
<input type="datetime-local" id="rs_time">

<label>Production Loss</label>
<input id="rs_loss">

<label>DG Deployed</label>
<input id="rs_dg">

<label>Remarks</label>
<textarea id="rs_rem"></textarea>

<br><br>
<button class="btn-resume" onclick="submitResume()">Submit Resume</button>
</div>

</div>

<div class="footer"><div id="msg"></div></div>

<script>
const WEBAPP_URL="https://script.google.com/macros/s/AKfycbz1g6vziMziteLRvxrVRtVr-xUOFdLrpDN4OqoiaDEv-c2h1-fUHk9nq2LueN4XuHHsKQ/exec";
const CSV_URL="https://docs.google.com/spreadsheets/d/12Vb60sr_ApZ6JBpE2D_nZweJhTk7DLDEf9XHfpIbJzQ/export?format=csv";

/* USERS */
const USERS=[
 {u:"124569",p:"1234",n:"KULDIP KHAROLIA",i:"LIMBODARA-GGS-1"},
 {u:"133668",p:"1234",n:"DIPAK MAURYA",i:"LIMBODARA-GGS-1"},
 {u:"124470",p:"1234",n:"SANDESH BHARDWAJ",i:"LIMBODARA-GGS-2"},
 {u:"135597",p:"1234",n:"KUNAL RANJAN",i:"LIMBODARA-GGS-2"},
 {u:"139938",p:"1234",n:"HAREKRISHNA",i:"LIMBODARA-GGS-2"},
 {u:"125223",p:"1234",n:"SUKUMAR LAHA",i:"GAMIJ-GGS-1"},
 {u:"139649",p:"1234",n:"RAVI KUMAR SHARMA",i:"GAMIJ-GGS-1"},
 {u:"137217",p:"1234",n:"SONUKUMAR SINGH",i:"GAMIJ-GGS-1"},
 {u:"121028",p:"1234",n:"ABHISHEK PATEL",i:"GAMIJ-GGS-2"},
 {u:"133181",p:"1234",n:"KETUL PATEL",i:"GAMIJ-GGS-2"},
 {u:"123310",p:"1234",n:"DHEERENDRA SINGH",i:"GAMIJ-GGS-3"},
 {u:"133643",p:"1234",n:"ASHUTOSH KUMAR SINGH",i:"GAMIJ-GGS-3"},
 {u:"135515",p:"1234",n:"ADITYA ARYA",i:"GAMIJ-GGS-3"},
 {u:"130594",p:"1234",n:"MAHESH GAJJAR",i:"MOTERA-GGS"}
];

/* FEEDERS */
const FEEDERS={
"LIMBODARA-GGS-1":["AKASH CERAMIC FEEDER","ITLA ONGC FEEDER - LG1","MANSA CITY FEEDER","MANSA CIVIL FEEDER"],
"LIMBODARA-GGS-2":["ITLA ONGC FEEDER - LG2","KIRTIDHAM FEEDER","LISA FEEDER","MAHAKALI FEEDER","MUBARAKPUR FEEDER","NETRA FEEDER","ROYAL FEEDER","TIRUPATI FEEDER","VARDAYINI FEEDER"],
"GAMIJ-GGS-1":["BAHIYAL ONGC FEEDER","RAM FEEDER - GAMIJ-1","SOMNATH JGY FEEDER","NAYRA JGY FEEDER","VASNA RATHOD FEEDER"],
"GAMIJ-GGS-2":["BADARPUR FEEDER","CHAULAJ FFEDER - GAMIJ - 2","GADWEL FEEDER","KASHTABHANJAN FEEDER","RAM FEEDR - GAMIJ-2"],
"GAMIJ-GGS-3":["BARMUVADA FEEDER","CHAULAJ FEEDER - GAMIJ - 3","FINAV FEEEDER","FUDAL MATA FEEDER","GAYATRI FEEDER","GINJAR FEEDER","HALDARWAS FEEDER GAMIJ - 3","HALDARWAS FEEDER GAMIJ - 4","KALPSAR FEEDER","SATRUNDA FEEDER - GAMIJ - 3","SATRUNDA FEEDER - GAMIJ - 4","SIHUNJ FEEDER,VANSOLI FEEDER"],
"MOTERA-GGS":["TP - 44 FEEDER","ZUNDAL AG FEEDER"]
};

let CURRENT_USER={};
let ACTIVE_SHUTDOWN_FEEDERS=[];

/* LOGIN */
function login(){
 const u=loginUser.value.trim();
 const p=loginPass.value.trim();
 const user=USERS.find(x=>x.u===u && x.p===p);
 if(!user){ showMsg("Invalid Login"); return; }

 CURRENT_USER=user;
 opName.value=user.n;
 installation.value=user.i;

 loginBox.classList.add("hidden");
 operatorBox.classList.remove("hidden");
 dashboardBox.classList.remove("hidden");

 populateFeeders();
 loadActiveShutdowns();
 setInterval(loadActiveShutdowns,30000);

 showMsg("Welcome "+user.n);
}

/* FEEDERS */
function populateFeeders(){
 sd_feeder.innerHTML=rs_feeder.innerHTML='<option value="">Select Feeder</option>';
 (FEEDERS[CURRENT_USER.i]||[]).forEach(f=>{
  sd_feeder.innerHTML+=`<option>${f}</option>`;
  rs_feeder.innerHTML+=`<option>${f}</option>`;
 });
}

/* DASHBOARD */
function loadActiveShutdowns(){
 fetch(CSV_URL)
 .then(r=>r.text())
 .then(t=>{

  const rows=t.split("\n").map(r=>r.split(","));
  const header=rows.shift().map(h=>h.trim());

  // ðŸ”¥ FLEXIBLE HEADER FIND
  const f = header.findIndex(h=>h.toLowerCase().includes("feeder"));
  const sd = header.findIndex(h=>h.toLowerCase().includes("shutdown"));
  const rs = header.findIndex(h=>h.toLowerCase().includes("resume"));
  const i = header.findIndex(h=>h.toLowerCase().includes("installation"));

  activeShutdowns.innerHTML="";
  ACTIVE_SHUTDOWN_FEEDERS=[];

  rows.forEach(r=>{
   if(
     r[i]?.trim()===CURRENT_USER.i &&
     r[sd]?.trim()!=="" &&
     (!r[rs] || r[rs].trim()==="")
   ){
    ACTIVE_SHUTDOWN_FEEDERS.push(r[f]);

    activeShutdowns.innerHTML+=`
     <div class="shutdown-item">
      ${r[f]}<br>
      Shutdown @ ${r[sd]}
     </div>`;
   }
  });

  if(ACTIVE_SHUTDOWN_FEEDERS.length===0){
   activeShutdowns.innerHTML="<i>No Active Shutdown</i>";
  }
 });
}

/* OPEN FORMS */
function openShutdown(){
 shutdownBox.classList.remove("hidden");
 resumeBox.classList.add("hidden");
}

function openResume(){
 resumeBox.classList.remove("hidden");
 shutdownBox.classList.add("hidden");
}

/* SHUTDOWN */
function submitShutdown(){
 if(!sd_feeder.value||!sd_time.value){
  showMsg("Feeder & Time required"); return;
 }

 fetch(WEBAPP_URL+"?"+new URLSearchParams({
  action:"shutdown",
  feeder:sd_feeder.value,
  ShutdownTime:sd_time.value.replace("T"," "),
  ShutdownType:sd_type.value,
  Information:sd_info.value,
  ShutdownEntryBy:CURRENT_USER.n,
  Installation:CURRENT_USER.i
 }),{mode:"no-cors"});

 showMsg("Shutdown submitted");
 setTimeout(loadActiveShutdowns,2000);
}

/* RESUME */
function submitResume(){
 if(!ACTIVE_SHUTDOWN_FEEDERS.includes(rs_feeder.value)){
  showMsg("Selected feeder is not in Shutdown");
  return;
 }

 if(!rs_time.value){
  showMsg("Resume time required"); return;
 }

 fetch(WEBAPP_URL+"?"+new URLSearchParams({
  action:"resume",
  feeder:rs_feeder.value,
  ResumeTime:rs_time.value.replace("T"," "),
  ResumeEntryBy:CURRENT_USER.n,
  TotalProdLoss:rs_loss.value,
  DGDeployed:rs_dg.value,
  Remarks:rs_rem.value
 }),{mode:"no-cors"});

 showMsg("Resume submitted");
 setTimeout(loadActiveShutdowns,2000);
}

/* MESSAGE */
function showMsg(t){
 msg.innerText=t;
 setTimeout(()=>msg.innerText="",3000);
}
</script>

</body>
</html>
