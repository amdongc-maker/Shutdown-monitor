<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DG Requirement â€“ Installation</title>

<style>
:root{
  --primary:#2563eb;
  --success:#22c55e;
  --danger:#ef4444;
  --bg:#f1f5f9;
}
body{
  margin:0;
  font-family:Segoe UI, Arial;
  background:var(--bg);
}
header{
  background:#2563eb;
  color:#fff;
  padding:16px;
  text-align:center;
  font-size:20px;
  font-weight:700;
}
.container{
  max-width:520px;
  margin:auto;
  padding:16px;
}
.card{
  background:#fff;
  border-radius:18px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 8px 20px rgba(0,0,0,0.08);
}

/* âœ… PERFECT INPUT ALIGNMENT */
input, select{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:12px;
  border:1px solid #ddd;
  box-sizing:border-box;
  font-size:14px;
}

/* Date fix */
input[type="date"]{
  width:100%;
  box-sizing:border-box;
}

/* Buttons */
button{
  width:100%;
  padding:14px;
  margin-top:12px;
  border:none;
  border-radius:14px;
  font-weight:700;
  cursor:pointer;
}
.btn-primary{background:var(--primary);color:white}
.btn-success{background:var(--success);color:white}

.hidden{display:none}
.well-row{display:flex;gap:8px;margin-top:8px}
.well-row input{flex:1}
.status-card{border-radius:16px;padding:14px;margin-bottom:12px;color:#000}

/* LOGIN CENTER */
#loginBox{
  max-width:360px;
  margin:auto;
  margin-top:40px;
}

/* STATUS COLORS */
.card-red{background:#fee2e2}
.card-orange{background:#ffedd5}
.card-green{background:#dcfce7}
.card-reject{background:#e5e7eb}
.dg-wa-btn{
  background: linear-gradient(45deg,#ff9800,#ff5722,#e91e63);
  color:white;
  padding:14px 26px;
  border:none;
  border-radius:12px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
  box-shadow:0 5px 15px rgba(0,0,0,0.35);
  font-family:Segoe UI, Arial;
}
.dg-wa-btn:hover{
  transform:scale(1.07);
}
</style>
</head>

<body>

<header>âš¡ DG REQUIREMENT â€“ INSTALLATION</header>

<div class="container">

<div class="card" id="loginBox">
<h3>Login</h3>
<input id="cpf" placeholder="CPF">
<input id="pass" type="password" placeholder="Password">
<button class="btn-primary" onclick="login()">Login</button>
<div id="loginMsg" style="color:red"></div>
</div>

<div class="hidden" id="mainBox">

<div class="card">
Welcome <b id="userName"></b><br>
Installation: <b id="userInst"></b>
</div>

<div class="card">
<h3>DG Requirement Form</h3>

<input type="date" id="shutdownDate"placeholder="Shutdown Date">
<select id="shutdownType">
  <option value="">Select Shutdown Type</option>
  <option>PLAN PSD</option>
  <option>UNPLAN PSD</option>
  <option>PARTIAL PLAN PSD</option>
  <option>PARTIAL UNPLAN PSD</option>
</select>
<input id="information" placeholder="Information / Remarks">
<select id="feeder">
<option value="">Select Feeder</option>
</select>

<div id="wells">
<div class="well-row">
<input placeholder="Well No">
<input placeholder="Capacity (Ton)" type="number">
</div>
</div>

<button onclick="addWell()">+ Add Well</button>
<button class="btn-success" onclick="submitRequest()">Submit</button>
</div>

<div class="card">
<h3>DG Requests</h3>
<div id="myRequests"></div>
</div>

</div>
</div>

<script>
function formatDateDMY(dateStr){
  let d = new Date(dateStr);
  let dd = String(d.getDate()).padStart(2,"0");
  let mm = String(d.getMonth()+1).padStart(2,"0");
  let yy = d.getFullYear();
  return dd+"-"+mm+"-"+yy;
}

const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwCEgVIXN_pVQVfIQuDm8BwkUaG8W_7N8TMn2tWXro_qauQSqR4Nko7XwqnK71Mcfit2Q/exec";

// USERS
const USERS=[
 {cpf:"124569",pass:"4321",name:"KULDIP KHAROLIA",inst:"LIMBODARA-GGS-1",mobile:"8291281604"},
 {cpf:"133668",pass:"4321",name:"DIPAK MAURYA",inst:"LIMBODARA-GGS-1",mobile:"9531107307"},
 {cpf:"124470",pass:"4321",name:"SANDESH BHARDWAJ",inst:"LIMBODARA-GGS-2",mobile:"7710091855"},
 {cpf:"135597",pass:"4321",name:"KUNAL RANJAN",inst:"LIMBODARA-GGS-2",mobile:"7710092605"},
 {cpf:"139938",pass:"4321",name:"HAREKRISHNA",inst:"LIMBODARA-GGS-2",mobile:"9428330103"},
 {cpf:"125223",pass:"4321",name:"SUKUMAR LAHA",inst:"GAMIJ-GGS-1",mobile:"9969229059"},
 {cpf:"139646",pass:"4321",name:"RAVI KUMAR SHARMA",inst:"GAMIJ-GGS-1",mobile:"9974691417"},
 {cpf:"137317",pass:"4321",name:"SONUKUMAR SINGH",inst:"GAMIJ-GGS-1",mobile:"7043217155"},
 {cpf:"121028",pass:"4321",name:"ABHISHEK PATEL",inst:"GAMIJ-GGS-2",mobile:"9428331281"},
 {cpf:"133181",pass:"4321",name:"KETUL PATEL",inst:"GAMIJ-GGS-2",mobile:"9512700869"},
 {cpf:"123310",pass:"4321",name:"DHEERENDRA SINGH",inst:"GAMIJ-GGS-3",mobile:"9427504416"},
 {cpf:"133643",pass:"4321",name:"ASHUTOSH KUMAR SINGH",inst:"GAMIJ-GGS-3",mobile:"7086051643"},
 {cpf:"135515",pass:"4321",name:"ADITYA ARYA",inst:"GAMIJ-GGS-3",mobile:"7043781664"}
];

// FEEDER LIST
const FEEDERS={
 "LIMBODARA-GGS-1":["AKASH CERAMIC FEEDER","ITLA ONGC FEEDER-LG1","MANSA CITY FEEDER","MANSA CIVIL FEEDER"],
 "LIMBODARA-GGS-2":["ITLA ONGC FEEDER-LG2","KIRTIDHAM FEEDER","LISA FEEDER","MAHAKALI FEEDER","MUBARAKPUR FEEDER","NETRA FEEDER","ROYAL FEEDER","TIRUPATI FEEDER","VARDAYINI FEEDER"],
 "GAMIJ-GGS-1":["BAHIYAL ONGC FEEDER","RAM FEEDER-GAMIJ-1","SOMNATH JGY FEEDER","NAYRA JGY FEEDER","VASNA RATHOD FEEDER"],
 "GAMIJ-GGS-2":["BADARPUR FEEDER","CHAULAJ FEEDER-GAMIJ-2","GADWEL FEEDER","KASHTABHANJAN FEEDER","RAM FEEDER-GAMIJ-2"],
 "GAMIJ-GGS-3":["BADARPUR FEEDER","BARMUVADA FEEDER","CHAULAJ FEEDER-GAMIJ-3","FINAV FEEDER","FUDAL MATA FEEDER","GAYATRI FEEDER","GINJAR FEEDER","HALDARWAS FEEDER","KALPSAR FEEDER","SATRUNDA FEEDER","SIHUNJ FEEDER","VANSOLI FEEDER"]
};

let CURRENT_USER=null;

// LOGIN
function login(){
 let u=USERS.find(x=>x.cpf==cpf.value && x.pass==pass.value);
 if(!u){ loginMsg.innerText="Invalid CPF or Password"; return; }

 CURRENT_USER=u;
 loginBox.classList.add("hidden");
 mainBox.classList.remove("hidden");
 userName.innerText=u.name;
 userInst.innerText=u.inst;

 loadFeeders();
 loadMyRequests();
}

// Load feeder list
function loadFeeders(){
 let list=FEEDERS[CURRENT_USER.inst]||[];
 feeder.innerHTML='<option value="">Select Feeder</option>';
 list.forEach(f=>{
   let op=document.createElement("option");
   op.textContent=f;
   op.value=f;
   feeder.appendChild(op);
 });
}

function addWell(){
 let d=document.createElement("div");
 d.className="well-row";
 d.innerHTML=`<input placeholder="Well No"><input placeholder="Capacity (Ton)" type="number">`;
 wells.appendChild(d);
}

function submitRequest(){
   // ðŸ”´ BASIC VALIDATION
 if(
   !shutdownDate.value ||
   !shutdownType.value ||
   !information.value.trim() ||
   !feeder.value
 ){
   alert("All fields are required");
   return;
 }
 let arr=[];
 document.querySelectorAll(".well-row").forEach(r=>{
  let i=r.querySelectorAll("input");
  if(i[0].value && i[1].value)
   arr.push({well:i[0].value,cap:Number(i[1].value)});
 });

 if(!arr.length){
   alert("Add at least one well");
   return;
 }

 let req={
  requestedBy:CURRENT_USER.name,
  mobile:CURRENT_USER.mobile,
  installation:CURRENT_USER.inst,
  shutdownDate:shutdownDate.value,
  shutdownType: shutdownType.value,
  information: information.value,   // â­ NEW
  feeder:feeder.value,
  wells:arr
};

 fetch(WEBAPP_URL+"?action=submitRequest&data="+encodeURIComponent(JSON.stringify(req)))
 .then(r=>r.json()).then(res=>{
  alert("Request ID "+res.requestId);
  loadMyRequests();
 });
}

// ðŸ”¥ WHATSAPP SHARE FUNCTION
function shareDGWhatsApp(req){

  let wellsText = "";
  req.wells.forEach(w=>{
    wellsText += "â€¢ " + w.well + " | " + w.cap + " Ton\n";
  });

  let msg = 
`âš¡ *DG REQUIREMENT REQUEST* âš¡

*Request ID : ${req.requestId}*
Installation : ${req.installation}
Shutdown Date : ${formatDateDMY(req.shutdownDate)}
Shutdown Type : ${req.shutdownType}
Feeder : ${req.feeder}
Requested By : ${req.requestedBy} (${req.mobile})

*Well Details:*
${wellsText}
*Total Wells : ${req.wells.length}*

Dear Sir,
Kindly arrange DG support to maintain uninterrupted production.

*â€” SHUTDOWN MONITORING SYSTEM*`;

  window.open("https://wa.me/?text=" + encodeURIComponent(msg));
}

function loadMyRequests(){
fetch(WEBAPP_URL+"?action=myRequests&inst="+CURRENT_USER.inst+"&t="+Date.now())
 .then(r=>r.json()).then(data=>{

  let map = {};
  data.forEach(d=>{
    if(!map[d.requestId]){
      map[d.requestId] = {
        requestId: d.requestId,
        shutdownDate: d.shutdownDate,
        shutdownType: d.shutdownType || "",
        information: d.information || "",
        feeder: d.feeder,
        requestedBy: d.requestedBy,
        mobile: d.mobile,
        installation: d.installation,
        fmpStatus: d.fmpStatus || "Pending",
        dgApprovalStatus: d.dgApprovalStatus || "Pending",
        dgDeployStatus: d.dgDeployStatus || "Not Sent",
        wells: []
      };
    }
    map[d.requestId].wells.push({
      well: d.well || "NA",
      cap: Number(d.cap || 0)
    });
  });

  let html="";

  Object.values(map).reverse().forEach(req=>{

    let colorClass="card-red";
    if(req.fmpStatus=="Forwarded") colorClass="card-orange";
    if(req.dgApprovalStatus=="Approved") colorClass="card-green";
    if(req.dgApprovalStatus=="Rejected") colorClass="card-reject";

    let wellsHtml="";
    let totalCap=0;

    req.wells.forEach(w=>{
      totalCap+=w.cap;
      wellsHtml+=`<div>â€¢ ${w.well} - ${w.cap} Ton</div>`;
    });

    html+=`
    <div class="status-card ${colorClass}">
      <b>ID:</b> ${req.requestId}<br>
      <b>Requested By:</b> ${req.requestedBy}<br>
      <b>Mobile:</b> ${req.mobile}<br>
      <b>Installation:</b> ${req.installation}<br>
      <b>Shutdown Date:</b> ${formatDateDMY(req.shutdownDate)}<br>
      <b>Shutdown Type:</b> ${req.shutdownType}<br>
      <b>Information:</b> ${req.information || ""}<br>
      <b>Feeder:</b> ${req.feeder}<br><br>

      <b>DG Requirements:</b>
      ${wellsHtml}
      <hr>
      <b>Total Wells:</b> ${req.wells.length}<br>
      <b>Total Production:</b> ${totalCap} Ton<br><br>
      <b>FMP Status:</b> ${req.fmpStatus}<br>
      <b>DG Approval Status:</b> ${req.dgApprovalStatus}<br>
      <b>DG Deployment Status:</b> ${req.dgDeployStatus}
      <button onclick='shareDGWhatsApp(${JSON.stringify(req)})' class="dg-wa-btn">
 Share WhatsApp
</button>
    </div>`;
  });

  myRequests.innerHTML = html || "No Requests";
 });
}
</script>

</body>

</html>

