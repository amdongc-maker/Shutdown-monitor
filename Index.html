<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>POWER SHUTDOWN MANAGEMENT APP - AREA-IV</title>

<style>
body{
  font-family:"Segoe UI",Roboto,Arial;
  background:#f1f3f6;
  margin:0;
}
header{
  background:#1f3a5f;
  color:#fff;
  padding:14px 18px;
  font-size:18px;
  font-weight:600;
  text-align:center;
}
.container{
  padding:16px;
  max-width:480px;
  margin:auto;
}
.card{margin-bottom:20px}
h2,h3{
  margin:12px 0;
  color:#1f3a5f;
  text-align:center;
}
input,select,textarea{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:10px;
  border:1px solid #dcdfe4;
  font-size:15px;
}
button{
  width:100%;
  padding:14px;
  margin-top:14px;
  font-size:16px;
  font-weight:600;
  border:none;
  border-radius:14px;
  cursor:pointer;
}
.btn-login{background:#1f3a5f;color:#fff}
.btn-shutdown{background:#e74c3c;color:#fff}
.btn-resume{background:#27ae60;color:#fff}
.btn-back{background:#7f8c8d;color:#fff}
.hidden{display:none}
.shutdown-item{
  background:#fff;
  border-radius:16px;
  padding:18px;
  margin-bottom:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}
.shutdown-row{
  display:flex;
  justify-content:space-between;
  margin-bottom:8px;
  font-size:14px;
}
.shutdown-label{color:#6b7280;font-weight:600}
.shutdown-value{font-weight:700}
.install-badge{
  padding:4px 12px;
  border-radius:999px;
  background:#e5f0ff;
  color:#1f3a5f;
  font-size:12px;
  font-weight:700;
}
#msg{text-align:center;margin-top:10px;font-weight:600}
</style>
</head>

<body>
<header>POWER SHUTDOWN MANAGEMENT APP - AREA-IV</header>

<div class="container">

<div class="card" id="loginBox">
<h3>USER LOGIN</h3>
<input id="loginUser" placeholder="Username">
<input type="password" id="loginPass" placeholder="Password">
<button class="btn-login" onclick="login()">Login</button>
</div>

<div class="card hidden" id="mainBox">
<h2>ACTIVE SHUTDOWN FEEDERS</h2>
<div id="activeShutdowns">Loading...</div>
<button class="btn-shutdown" onclick="openShutdown()">Shutdown</button>
<button class="btn-resume" onclick="openResume()">Resume</button>
</div>

<div class="card hidden" id="shutdownBox">
<h3>Shutdown Entry</h3>
<select id="sd_feeder"></select>
<input type="datetime-local" id="sd_time">
<select id="sd_type">
<option>PLAN PSD</option>
<option>PARTIAL PLAN PSD</option>
<option>UNPLAN PSD</option>
<option>PARTIAL UNPLAN PSD</option>
</select>
<textarea id="sd_info" placeholder="Information"></textarea>
<button class="btn-shutdown" onclick="submitShutdown()">Submit</button>
<button class="btn-back" onclick="backToMain()">Back</button>
</div>

<div class="card hidden" id="resumeBox">
<h3>Resume Entry</h3>
<select id="rs_feeder"></select>
<input type="datetime-local" id="rs_time">
<input id="rs_loss" placeholder="Production Loss">
<input id="rs_dg" placeholder="DG Deployed">
<textarea id="rs_rem" placeholder="Remarks"></textarea>
<button class="btn-resume" onclick="submitResume()">Submit</button>
<button class="btn-back" onclick="backToMain()">Back</button>
</div>

<div id="msg"></div>
</div>

<script>
/* ===== DOM REFERENCES (MANDATORY FIX) ===== */
const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");
const loginBox = document.getElementById("loginBox");
const mainBox = document.getElementById("mainBox");
const shutdownBox = document.getElementById("shutdownBox");
const resumeBox = document.getElementById("resumeBox");
const activeShutdowns = document.getElementById("activeShutdowns");
const sd_feeder = document.getElementById("sd_feeder");
const rs_feeder = document.getElementById("rs_feeder");
const sd_time = document.getElementById("sd_time");
const rs_time = document.getElementById("rs_time");
const sd_type = document.getElementById("sd_type");
const sd_info = document.getElementById("sd_info");
const rs_loss = document.getElementById("rs_loss");
const rs_dg = document.getElementById("rs_dg");
const rs_rem = document.getElementById("rs_rem");
const msg = document.getElementById("msg");
/* ======================================== */

const WEBAPP_URL="https://script.google.com/macros/s/AKfycbz1g6vziMziteLRvxrVRtVr-xUOFdLrpDN4OqoiaDEv-c2h1-fUHk9nq2LueN4XuHHsKQ/exec";
const CSV_URL="https://docs.google.com/spreadsheets/d/12Vb60sr_ApZ6JBpE2D_nZweJhTk7DLDEf9XHfpIbJzQ/export?format=csv";

const USERS=[
 {u:"121318",p:"admin123",n:"SYSTEM ADMIN",i:"ALL",admin:true},
 {u:"124569",p:"1234",n:"KULDIP KHAROLIA",i:"LIMBODARA-GGS-1"}
];

const FEEDERS={
 "LIMBODARA-GGS-1":["AKASH CERAMIC FEEDER","ITLA ONGC FEEDER-LG1"],
 "ALL":["AKASH CERAMIC FEEDER","ITLA ONGC FEEDER-LG1"]
};

let CURRENT_USER={};

function login(){
 const user=USERS.find(x=>x.u===loginUser.value && x.p===loginPass.value);
 if(!user){showMsg("Invalid Login");return;}
 CURRENT_USER=user;
 loginBox.classList.add("hidden");
 mainBox.classList.remove("hidden");
 populateFeeders();
 loadActiveShutdowns();
}

function populateFeeders(){
 sd_feeder.innerHTML=rs_feeder.innerHTML="";
 (FEEDERS[CURRENT_USER.i]||[]).forEach(f=>{
  sd_feeder.innerHTML+=`<option>${f}</option>`;
  rs_feeder.innerHTML+=`<option>${f}</option>`;
 });
}

function loadActiveShutdowns(){
 fetch(CSV_URL+"&t="+Date.now())
 .then(r=>r.text())
 .then(t=>{
  const rows=t.trim().split("\n").map(r=>r.replace(/\r/g,"").split(","));
  const h=rows.shift().map(x=>x.toUpperCase());

  const idx={
   feeder:h.findIndex(x=>x.includes("FEEDER")),
   type:h.findIndex(x=>x.includes("TYPE")),
   sd:h.findIndex(x=>x.includes("SHUTDOWN")),
   rs:h.findIndex(x=>x.includes("RESUME")),
   inst:h.findIndex(x=>x.includes("INSTALL"))
  };

  activeShutdowns.innerHTML="";
  let count=0;

  rows.forEach(r=>{
   if(!r[idx.rs] || r[idx.rs]==="NA"){
    count++;
    activeShutdowns.innerHTML+=`
    <div class="shutdown-item">
     <div class="shutdown-row"><span class="shutdown-label">FEEDER</span><span class="shutdown-value">${r[idx.feeder]}</span></div>
     <div class="shutdown-row"><span class="shutdown-label">TYPE</span><span class="shutdown-value">${r[idx.type]}</span></div>
     <div class="shutdown-row"><span class="shutdown-label">TIME</span><span class="shutdown-value">${r[idx.sd]}</span></div>
     <div class="shutdown-row"><span class="shutdown-label">INSTALLATION</span><span class="install-badge">${r[idx.inst]}</span></div>
    </div>`;
   }
  });

  if(count===0){
   activeShutdowns.innerHTML=`<div class="shutdown-item" style="text-align:center;color:#27ae60;font-weight:700">âœ… ALL FEEDERS HEALTHY</div>`;
  }
 });
}

function openShutdown(){mainBox.classList.add("hidden");shutdownBox.classList.remove("hidden")}
function openResume(){mainBox.classList.add("hidden");resumeBox.classList.remove("hidden")}

function backToMain(){
 shutdownBox.classList.add("hidden");
 resumeBox.classList.add("hidden");
 mainBox.classList.remove("hidden");
 loadActiveShutdowns();
}

function submitShutdown(){
 fetch(WEBAPP_URL+"?"+new URLSearchParams({
  action:"shutdown",
  feeder:sd_feeder.value,
  ShutdownTime:sd_time.value.replace("T"," "),
  ShutdownType:sd_type.value,
  Information:sd_info.value,
  ShutdownEntryBy:CURRENT_USER.n,
  Installation:CURRENT_USER.i
 }),{mode:"no-cors"});
 showMsg("Shutdown Submitted");
 backToMain();
}

function submitResume(){
 fetch(WEBAPP_URL+"?"+new URLSearchParams({
  action:"resume",
  feeder:rs_feeder.value,
  ResumeTime:rs_time.value.replace("T"," "),
  ResumeEntryBy:CURRENT_USER.n,
  TotalProdLoss:rs_loss.value,
  DGDeployed:rs_dg.value,
  Remarks:rs_rem.value
 }),{mode:"no-cors"});
 showMsg("Resume Submitted");
 backToMain();
}

function showMsg(t){
 msg.innerText=t;
 setTimeout(()=>msg.innerText="",3000);
}

setInterval(loadActiveShutdowns,30000);
</script>
</body>
</html>
