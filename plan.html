<script>
/* ✅ USER SESSION FROM INDEX.HTML */
let CURRENT_USER = JSON.parse(localStorage.getItem("CURRENT_USER"));

if (!CURRENT_USER) {
  alert("Session expired. Please login again.");
  window.location.href = "index.html";
}

/* ✅ SCRIPT URL */
const SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbw-yiypiQPY_Bj8EQSlygCZxZwhGPCzbcgxd5WxFYvIQdGIGhrqIqYlCucYqHglDuv6Tg/exec";

/* ✅ FEEDERS LIST */
const FEEDERS = {
  "LIMBODARA-GGS-1": ["AKASH CERAMIC FEEDER","ITLA ONGC FEEDER-LG1","MANSA CITY FEEDER","MANSA CIVIL FEEDER"],
  "LIMBODARA-GGS-2": ["ITLA ONGC FEEDER-LG2","KIRTIDHAM FEEDER","LISA FEEDER"],
  "GAMIJ-GGS-1": ["BAHIYAL ONGC FEEDER","RAM FEEDER-GAMIJ-1"],
  "GAMIJ-GGS-2": ["BADARPUR FEEDER","CHAULAJ FEEDER-GAMIJ-2"],
  "GAMIJ-GGS-3": ["BARMUVADA FEEDER","GINJAR FEEDER"],
  "MOTERA-GGS": ["TP-44 FEEDER","ZUNDAL AG FEEDER"],
  "ALL": []
};

/* ✅ AUTO LOAD ON PAGE OPEN */
window.onload = function () {

  // ✅ Auto Fill Installation & EntryBy
  installation.value = CURRENT_USER.i;
  entryby.value = CURRENT_USER.n;

  // ✅ Auto Load Feeder Dropdown
  loadFeeders();

  // ✅ Load Existing Plans Table
  loadPlans();
};

/* ✅ POPULATE FEEDERS */
function loadFeeders() {
  feeder.innerHTML = "<option value=''>-- Select Feeder --</option>";

  (FEEDERS[CURRENT_USER.i] || []).forEach(f => {
    feeder.innerHTML += `<option value="${f}">${f}</option>`;
  });
}

/* ✅ SAVE PLAN ENTRY */
function savePlan() {

  if (!date.value || !from.value || !to.value || !feeder.value) {
    alert("All fields required");
    return;
  }

  fetch(SCRIPT_URL + "?" + new URLSearchParams({
    action: "plan",
    feeder: feeder.value,
    date: date.value,
    from: from.value,
    to: to.value,
    installation: installation.value,
    reason: reason.value,
    entryby: entryby.value
  }))
    .then(r => r.text())
    .then(msg => {
      alert("✅ Plan Saved Successfully");
      loadPlans();
    });
}

/* ✅ LOAD PLAN LIST TABLE */
function loadPlans() {

  fetch(SCRIPT_URL + "?action=getallplans")
    .then(r => r.json())
    .then(data => {

      let html = `
        <tr>
          <th>Date</th>
          <th>From</th>
          <th>To</th>
          <th>Feeder</th>
          <th>Installation</th>
          <th>Reason</th>
        </tr>`;

      let today = new Date();
      today.setHours(0, 0, 0, 0);

      data.reverse().forEach(r => {

        let d = new Date(r.date);
        d.setHours(0, 0, 0, 0);

        let cls = (d >= today) ? "red" : "green";

        html += `
          <tr class="${cls}">
            <td>${r.date}</td>
            <td>${r.from}</td>
            <td>${r.to}</td>
            <td>${r.feeder}</td>
            <td>${r.installation}</td>
            <td>${r.reason || ""}</td>
          </tr>`;
      });

      planTable.innerHTML = html;
    });
}
</script>
